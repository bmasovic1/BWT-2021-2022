const {createConnection} = require('net')
const {SocketServer} = require('./lib')
const server = new SocketServer()

server.withArgs('Hello').resolves('World')

server
  .start()
  .then(() => {
    console.log('server started')
    return new Promise((resolve, reject) => {
      const client = createConnection(server.endpoint, () => {
        console.log('connected to server!')
        client.write('Hello')
      })
      client.on('data', (data) => {
        console.log(data.toString())
        client.end()
      })
      client.on('error', (error) => {
        console.log(error)
        client.end()
      })
      client.on('end', () => {
        console.log('disconnected from server')
        resolve()
      })
    })
  })
  .then(() => server.stop())
  .then(() => process.exit(0))
